let c=null,i=null,a=null,s=!1;const p="https://dummy.server.com/session",y="https://dummy.server.com/html";chrome.runtime.onInstalled.addListener(()=>{chrome.storage.local.get(["events","settings"],e=>{e.events||chrome.storage.local.set({events:[]}),e.settings||chrome.storage.local.set({settings:{contentScanning:!1,excludeList:[]}})})});function l(e){chrome.storage.local.get({events:[]},t=>{const n=t.events||[],r=Date.now()-336*60*60*1e3,o=n.filter(m=>m.ts>=r);o.push(e),chrome.storage.local.set({events:o})})}async function g(e,t,n){const r=Math.round((n-t)/1e3);try{await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,startTime:t,endTime:n,duration:r})})}catch(o){console.warn("SESSION API ERROR",o)}}async function f(e,t){try{await fetch(y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,html:t})})}catch(n){console.warn("HTML API ERROR",n)}}function S(e){return new Promise(t=>{chrome.scripting.executeScript({target:{tabId:e},files:["content/contentScript.js"]},()=>{chrome.tabs.sendMessage(e,{type:"request_full_text"},n=>t(n?.text||""))})})}async function d(){if(!c||!i||!a)return;const e=Date.now(),t=c,n=a,r=Math.round((e-i)/1e3),o=await S(t);g(n,i,e),f(n,o),l({type:"session_end",url:n,duration:r,ts:e}),c=null,i=null,a=null}function u(e){!e||!e.url||s||e.url.startsWith("chrome://")||e.url.startsWith("chrome-extension://")||chrome.storage.local.get({settings:{excludeList:[]}},t=>{(t.settings.excludeList||[]).some(r=>e.url.includes(r))||((c!==e.id||a!==e.url)&&d(),c=e.id,a=e.url,i=Date.now(),l({type:"session_start",url:e.url,ts:i}))})}chrome.tabs.onActivated.addListener(async e=>{if(s)return;const t=await chrome.tabs.get(e.tabId);u(t)});let h=null;chrome.windows.onFocusChanged.addListener(e=>{s||(e===chrome.windows.WINDOW_ID_NONE?h=setTimeout(()=>d(),250):(clearTimeout(h),chrome.tabs.query({active:!0,windowId:e},t=>{t[0]&&u(t[0])})))});chrome.tabs.onUpdated.addListener((e,t,n)=>{s||e===c&&t.url&&u(n)});chrome.runtime.onMessage.addListener((e,t,n)=>{if(e?.type){if(e.type==="pause")return s=!0,d(),n({paused:!0}),!0;if(e.type==="resume")return s=!1,chrome.tabs.query({active:!0,currentWindow:!0},r=>{r[0]&&u(r[0])}),n({paused:!1}),!0;if(e.type==="getStatus")return n({paused:s}),!0;if(e.type==="engagement")return l({type:"engagement",url:t.tab?.url||"",data:e.data,ts:Date.now()}),n({ok:!0}),!0;if(e.type==="page_html")return f(t.tab?.url||"",e.text),n({ok:!0}),!0}});
